<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Map Marker</title>
<script src="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.11.0/mapbox-gl.css" rel="stylesheet" />
<style>
  body { margin: 0; padding: 0; }
  #map { position: absolute; top: 0; bottom: 0; width: 100%; }

  .customMarker {
      background-image: url('MTS_Bus_icon.svg');
      background-size: cover;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      cursor: pointer;
  }

</style>
</head>
<body>
  
<div id="map"></div>
 
<script>
    let busses = [];
    let map = null;


    function setupMap() {
        map = new mapboxgl.Map({
            accessToken: "pk.eyJ1IjoiYi1zZWJlIiwiYSI6ImNrczg0bnM4NTBscjYybm8yMWVqYWp3Y2kifQ.6ZbuMId34XsGbDapIiqi2Q",
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-streets-v11',
            center: [-71.091542,42.358862],
            zoom: 12
        });
    }

    function findBus(id, busses) {
        for (busIndex in busses) {
            let bus = busses[busIndex];
            if (bus.id === id) {
                return bus;
            }
        }
        return null;
    }

  // Request bus data from MBTA
    async function getBusLocations(){
        const url = 'https://api-v3.mbta.com/vehicles?filter[route]=1&include=trip';
        const response = await fetch(url);
        const json     = await response.json();
        return json.data;
    }


    async function run(){
        // get bus data    
        const locations = await getBusLocations();
        // console.log(new Date());
        // console.log(locations);


        locations.forEach( bus => {
            const busRecord = findBus(bus.id, busses);
            if (busRecord) {
                console.log("Updating position for bus:" + bus.id);
                busRecord.marker.setLngLat([bus.attributes.longitude, bus.attributes.latitude]);
            } else {
                console.log("Adding new marker for " + bus.id);
                var el = document.createElement('div');
                el.className = "customMarker";
                var marker = new mapboxgl.Marker(el).setLngLat([bus.attributes.longitude, bus.attributes.latitude]).addTo(map);
                busses.push({
                    id: bus.id,
                    marker: marker
                });
            }
        });


        // timer
        setTimeout(run, 15000);
    }

    setupMap();
    run();

</script>
 
</body>
</html>